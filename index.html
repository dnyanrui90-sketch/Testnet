<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TESTNEST</title>

  <!-- PWA meta (FULL install still needs 2 extra files: manifest.json + sw.js) -->
  <meta name="theme-color" content="#ff6b35">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TESTNEST">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <!-- If you add manifest.json later, uncomment next line:
  <link rel="manifest" href="./manifest.json">
  -->

  <!-- Firebase (Compat for single-file GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.14);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,0.70);
      --brand:#ff6b35;
      --brand2:#4b7bec;
      --ok:#2ecc71;
      --bad:#ff4757;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(75,123,236,0.28), transparent 55%),
                  radial-gradient(900px 600px at 80% 10%, rgba(255,107,53,0.22), transparent 60%),
                  linear-gradient(180deg, #070a14, var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(10,14,30,0.65);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:0.6px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 30px rgba(255,107,53,0.25);
    }
    .brand span{font-size:18px}
    .pill{
      padding:8px 12px; border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      border-radius:999px;
      font-size:12px; color:var(--muted);
      max-width:60vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px 40px;}
    .grid{display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px;}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.45}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:none; cursor:pointer; font-weight:800;
      border-radius: 14px;
      padding:12px 14px;
      transition: transform .08s ease, filter .12s ease;
    }
    button:active{transform: scale(.98)}
    .btn-brand{background: linear-gradient(135deg, var(--brand), #ff915f); color:#120a07;}
    .btn-blue{background: linear-gradient(135deg, var(--brand2), #6ea6ff); color:#081022;}
    .btn-dark{background: rgba(0,0,0,0.25); color:var(--text); border:1px solid rgba(255,255,255,0.14);}
    .btn-ok{background: linear-gradient(135deg, var(--ok), #7bed9f); color:#04140b;}
    .btn-bad{background: linear-gradient(135deg, var(--bad), #ff6b81); color:#24060b;}
    .btn{background: rgba(255,255,255,0.10); color:var(--text); border:1px solid rgba(255,255,255,0.14);}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1; min-width:220px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px}
    .divider{height:1px; background: rgba(255,255,255,0.10); margin:14px 0}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
      color: var(--muted);
    }
    .course{
      padding:14px; border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-bottom:10px;
    }
    .course b{font-size:15px}
    .lock{color:#ffd2c2}
    .timer{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:900; font-size:16px; color:#ffd2c2;
    }
    .qbox{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding:12px; margin:10px 0;
    }
    .opt{display:block; padding:8px 10px; margin:7px 0; border-radius:12px;
      border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.18)}
    .small{font-size:12px; color:var(--muted)}
    .toast{
      position: fixed; bottom:18px; left:50%; transform:translateX(-50%);
      background: rgba(0,0,0,0.75);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.12);
      padding:10px 14px;
      border-radius: 12px;
      display:none;
      z-index:999;
      max-width: 92vw;
    }
    .hero{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;}
    .hero h1{margin:0; font-size:28px}
    .hero .sub{color:var(--muted); max-width:60ch; line-height:1.5}
    .errbox{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,71,87,0.35);
      background: rgba(255,71,87,0.10);
      color:#ffd7dc;
      display:none;
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo"></div>
      <span>TESTNEST</span>
    </div>
    <div class="pill" id="topStatus">Not logged in</div>
  </div>
</div>

<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="hero">
      <div>
        <h1>Learn ‚Ä¢ Practice ‚Ä¢ Test</h1>
        <div class="sub">Student login for tests + Leaderboard. Admin login to create courses, add unlimited questions, lock paid courses, and manage questions (edit/delete/trash).</div>
        <div style="margin-top:10px" class="row">
          <span class="tag">‚úÖ Timer Test</span>
          <span class="tag">‚úÖ Auto Result</span>
          <span class="tag">‚úÖ Leaderboard</span>
          <span class="tag">‚úÖ Paid Lock</span>
          <span class="tag">‚úÖ Admin Edit/Delete</span>
        </div>
      </div>
      <div style="min-width:260px; width:360px; max-width:100%;">
        <div class="card" style="box-shadow:none; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10);">
          <h3 style="margin:0 0 8px 0;">Login</h3>
          <div class="muted">iPhone uses Popup login. Android/Desktop uses Redirect. If iPhone fails inside WhatsApp browser, open in Safari.</div>

          <div class="btnrow" style="margin-top:12px;">
            <button class="btn-brand" onclick="loginAs('student')">Student Login (Google)</button>
            <button class="btn-blue" onclick="loginAs('admin')">Admin Login (Google)</button>
          </div>

          <div class="errbox" id="errBox"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="row" style="align-items:center">
          <div>
            <h2 style="margin:0">Courses</h2>
            <div class="muted">Start a free test. Paid courses show locked (unlock system can be added next).</div>
          </div>
          <div style="text-align:right">
            <button class="btn-dark" onclick="logout()">Logout</button>
          </div>
        </div>

        <div class="divider"></div>
        <div id="courseList">Loading...</div>

        <div class="divider"></div>

        <div id="testBox" style="display:none;">
          <div class="row" style="align-items:center">
            <div>
              <h3 id="testTitle" style="margin:0 0 4px 0;">Test</h3>
              <div class="small" id="qCountInfo"></div>
            </div>
            <div class="timer" id="timerDisplay">00:00</div>
          </div>
          <div id="questionArea"></div>
          <div class="btnrow">
            <button class="btn-ok" onclick="submitTest()">Submit Test</button>
            <button class="btn-bad" onclick="closeTest()">Close</button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Profile</h3>
          <div><b id="userName">‚Äî</b></div>
          <div class="small" id="userEmail">‚Äî</div>
          <div class="small" id="userRole">Role: ‚Äî</div>
        </div>

        <!-- ADMIN PANEL -->
        <div class="card" id="adminCard" style="display:none; margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">Admin Panel</h3>
          <div class="muted">Create courses, lock paid courses, add/edit/delete questions, image/audio links. Includes search, trash recovery, bulk delete.</div>

          <div class="divider"></div>

          <label>Course Name</label>
          <input type="text" id="courseName" placeholder="e.g., Class 1 / Class 6 Maths / NEET / JEE" />
          <label style="display:flex; align-items:center; gap:10px; margin-top:8px;">
            <input type="checkbox" id="paidCourse" style="width:18px;height:18px; accent-color: var(--brand);"> Paid Course (Locked)
          </label>
          <button class="btn-ok" onclick="addCourse()">Save Course</button>

          <div class="divider"></div>

          <label>Select course</label>
          <select id="coursePick" onchange="loadAdminQuestions()">
            <option value="">Select course</option>
          </select>

          <div class="row">
            <div>
              <label>Search questions</label>
              <input type="text" id="qSearch" placeholder="Search by question text..." oninput="renderAdminQuestions()">
            </div>
            <div>
              <label>View</label>
              <select id="qViewMode" onchange="loadAdminQuestions()">
                <option value="active">Active Questions</option>
                <option value="trash">Trash (Soft Deleted)</option>
              </select>
            </div>
          </div>

          <div class="btnrow" style="margin-top:10px;">
            <button class="btn" onclick="selectAllAdmin(true)">Select All</button>
            <button class="btn" onclick="selectAllAdmin(false)">Unselect All</button>
            <button class="btn-bad" onclick="bulkDeleteSelected()">Bulk Delete Selected</button>
            <button class="btn-ok" onclick="bulkRestoreSelected()">Restore Selected</button>
          </div>

          <div class="divider"></div>

          <h4 style="margin:0 0 8px 0;">Add / Edit Question</h4>

          <input type="hidden" id="editQuestionId" value="">

          <label>Question</label>
          <textarea id="questionText" placeholder="Type your question..."></textarea>

          <div class="row">
            <div><label>Option A</label><input type="text" id="opt1" placeholder="Option A" /></div>
            <div><label>Option B</label><input type="text" id="opt2" placeholder="Option B" /></div>
          </div>
          <div class="row">
            <div><label>Option C</label><input type="text" id="opt3" placeholder="Option C" /></div>
            <div><label>Option D</label><input type="text" id="opt4" placeholder="Option D" /></div>
          </div>

          <div class="row">
            <div><label>Correct Option Index</label><input type="number" id="correct" placeholder="0=A, 1=B, 2=C, 3=D" /></div>
            <div><label>Test Time (minutes)</label><input type="number" id="timeLimit" placeholder="Example: 5" /></div>
          </div>

          <div class="row">
            <div>
              <label>Image URL (optional)</label>
              <input type="text" id="imgUrl" placeholder="https://...jpg/png/webp" />
            </div>
            <div>
              <label>Audio URL (optional)</label>
              <input type="text" id="audUrl" placeholder="https://...mp3/m4a/wav" />
            </div>
          </div>

          <div class="btnrow" style="margin-top:10px;">
            <button class="btn-brand" onclick="saveQuestion()">Save Question</button>
            <button class="btn" onclick="clearQuestionForm()">Add Next Question</button>
          </div>

          <div class="divider"></div>

          <h4 style="margin:0 0 8px 0;">Questions</h4>
          <div class="small" id="adminQInfo">Select a course to load questions.</div>
          <div id="adminQList" style="margin-top:10px;"></div>
        </div>

        <!-- LEADERBOARD -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">Leaderboard (Top 10)</h3>
          <div class="small">Top scores across all courses.</div>
          <div class="divider"></div>
          <div id="leaderboard">Loading...</div>
        </div>
      </div>

    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   FIREBASE CONFIG
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAPML8zK9qgRQbUyv7lMVOtt0c5Osjyw_A",
  authDomain: "testnest-education.firebaseapp.com",
  projectId: "testnest-education",
  storageBucket: "testnest-education.firebasestorage.app",
  messagingSenderId: "1000142199756",
  appId: "1:1000142199756:web:afab8eaa0f6bc638969b69",
  measurementId: "G-0TCQF9WGB3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   ADMIN EMAILS
========================= */
const ADMIN_EMAILS = [
  "dnyanrui90@gmail.com",
  "pawarjai999@gmail.com"
];

/* =========================
   HELPERS
========================= */
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(()=> el.style.display="none", 2500);
}
function setTopStatus(msg){ document.getElementById("topStatus").textContent = msg; }
function showError(msg){
  const box = document.getElementById("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function clearError(){
  const box = document.getElementById("errBox");
  box.style.display = "none";
  box.textContent = "";
}
function escapeQuotes(s){ return (s||"").replace(/'/g,"\\'"); }
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =========================
   AUTH
========================= */
const ROLE_KEY = "tn_role";
let currentRole = "student";

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}
function isStandalonePWA(){
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}

function loginAs(role){
  clearError();
  localStorage.setItem(ROLE_KEY, role);
  const provider = new firebase.auth.GoogleAuthProvider();

  // iPhone/PWA: Popup (redirect may fail with missing initial state)
  if (isIOS() || isStandalonePWA()) {
    auth.signInWithPopup(provider).catch((e)=>{
      showError("Login error:\n" + (e.code || "") + "\n" + (e.message || ""));
    });
    return;
  }

  // Default: Redirect
  auth.signInWithRedirect(provider).catch((e)=>{
    showError("Login error:\n" + (e.code || "") + "\n" + (e.message || ""));
  });
}

// redirect return
auth.getRedirectResult().catch((e)=>{
  showError("Redirect error:\n" + (e.code || "") + "\n" + (e.message || ""));
});

function logout(){
  auth.signOut().then(()=>{
    document.getElementById("app").style.display="none";
    document.getElementById("loginCard").style.display="block";
    setTopStatus("Not logged in");
  });
}

auth.onAuthStateChanged((user)=>{
  if(!user){
    setTopStatus("Not logged in");
    return;
  }
  clearError();

  const intendedRole = (localStorage.getItem(ROLE_KEY) || "student").toLowerCase();
  const email = (user.email || "").toLowerCase();
  const isAdminEmail = ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(email);
  currentRole = (intendedRole === "admin" && isAdminEmail) ? "admin" : "student";

  document.getElementById("loginCard").style.display="none";
  document.getElementById("app").style.display="block";

  document.getElementById("userName").textContent = user.displayName || "Student";
  document.getElementById("userEmail").textContent = user.email || "";
  document.getElementById("userRole").textContent = "Role: " + currentRole.toUpperCase();
  setTopStatus((user.displayName || "User") + " ‚Ä¢ " + currentRole.toUpperCase());

  document.getElementById("adminCard").style.display = (currentRole === "admin") ? "block" : "none";

  loadCourses();
  loadLeaderboard();
  refreshCoursePick();

  if(currentRole === "admin"){
    setTimeout(loadAdminQuestions, 400);
  }
});

/* =========================
   ADMIN: COURSES
========================= */
function addCourse(){
  if(currentRole !== "admin") return alert("Admin only");
  const name = document.getElementById("courseName").value.trim();
  const paid = document.getElementById("paidCourse").checked;
  if(!name) return alert("Enter course name");

  db.collection("courses").doc(name).set({
    paid: paid,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdBy: auth.currentUser.email || ""
  }, { merge:true })
  .then(()=>{
    toast("Course saved!");
    loadCourses();
    refreshCoursePick();
  })
  .catch(e=>alert(e.message));
}

function refreshCoursePick(){
  const sel = document.getElementById("coursePick");
  if(!sel) return;
  sel.innerHTML = `<option value="">Select course</option>`;

  db.collection("courses").get().then(snap=>{
    snap.forEach(doc=>{
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = doc.id;
      sel.appendChild(opt);
    });
  }).catch(()=>{});
}

/* =========================
   COURSES (STUDENT VIEW)
========================= */
function loadCourses(){
  const div = document.getElementById("courseList");
  div.innerHTML = "Loading...";

  db.collection("courses").get().then(snapshot=>{
    if(snapshot.empty){
      div.innerHTML = `<div class="muted">No courses yet. Admin add course first.</div>`;
      return;
    }
    let html = "";
    snapshot.forEach(doc=>{
      const courseName = doc.id;
      const paid = !!doc.data().paid;

      html += `<div class="course">
        <div>
          <b>${escapeHtml(courseName)}</b><br/>
          <span class="small">${paid ? "Paid course (Locked)" : "Free course (Test available)"}</span>
        </div>
        <div style="min-width:180px; text-align:right">
          ${paid
            ? `<span class="tag lock">üîí Locked</span>`
            : `<button class="btn-ok" onclick="startTest('${escapeQuotes(courseName)}')">Start Test</button>`
          }
        </div>
      </div>`;
    });
    div.innerHTML = html;
  }).catch(e=>{
    div.innerHTML = `<div class="muted">${escapeHtml(e.message)}</div>`;
  });
}

/* =========================
   TEST (TIMER + AUTO RESULT)
========================= */
let currentCourse = "";
let currentQuestions = [];
let timeLeft = 0;
let timerInt = null;

function startTest(course){
  currentCourse = course;
  document.getElementById("testTitle").textContent = "Test: " + course;
  document.getElementById("testBox").style.display = "block";
  document.getElementById("questionArea").innerHTML = "Loading questions...";
  document.getElementById("qCountInfo").textContent = "";
  stopTimer();

  db.collection("courses").doc(course).collection("questions")
    .where("deleted","==",false)
    .get()
    .then(snapshot=>{
      currentQuestions = [];
      snapshot.forEach(doc => currentQuestions.push(doc.data()));

      if(currentQuestions.length === 0){
        document.getElementById("questionArea").innerHTML =
          `<div class="muted">No questions in this course yet. Admin add questions.</div>`;
        return;
      }

      document.getElementById("qCountInfo").textContent = currentQuestions.length + " questions";
      renderTest();

      // time from first question (or default 5 mins)
      const mins = (currentQuestions[0].time || 5);
      startTimer(mins * 60);
    })
    .catch(e=>alert(e.message));
}

function renderTest(){
  const div = document.getElementById("questionArea");
  div.innerHTML = "";

  currentQuestions.forEach((q,i)=>{
    let optsHtml = "";
    (q.options || []).forEach((opt,idx)=>{
      optsHtml += `
        <label class="opt">
          <input type="radio" name="q${i}" value="${idx}" style="accent-color: var(--brand); transform: translateY(2px);">
          <span style="margin-left:8px">${escapeHtml(opt)}</span>
        </label>
      `;
    });

    const img = q.imageUrl ? `
      <div style="margin:10px 0;">
        <img src="${escapeHtml(q.imageUrl)}" alt="Question Image"
          style="max-width:100%; border-radius:12px; border:1px solid rgba(255,255,255,0.12)">
      </div>` : "";

    const aud = q.audioUrl ? `
      <div style="margin:10px 0;">
        <audio controls style="width:100%">
          <source src="${escapeHtml(q.audioUrl)}">
        </audio>
      </div>` : "";

    div.innerHTML += `
      <div class="qbox">
        <b>${i+1}. ${escapeHtml(q.question)}</b>
        ${img}
        ${aud}
        <div style="margin-top:8px">${optsHtml}</div>
      </div>
    `;
  });
}

function startTimer(seconds){
  stopTimer();
  timeLeft = seconds;
  updateTimerUI();
  timerInt = setInterval(()=>{
    timeLeft--;
    updateTimerUI();
    if(timeLeft <= 0){
      stopTimer();
      submitTest();
    }
  }, 1000);
}
function stopTimer(){ if(timerInt) clearInterval(timerInt); timerInt = null; }
function updateTimerUI(){
  const m = Math.floor(timeLeft/60);
  const s = timeLeft%60;
  document.getElementById("timerDisplay").textContent =
    (m<10?"0":"")+m+":"+(s<10?"0":"")+s;
}
function closeTest(){
  stopTimer();
  document.getElementById("testBox").style.display = "none";
}

function submitTest(){
  stopTimer();
  if(currentQuestions.length === 0){ alert("No questions."); return; }

  let score = 0;
  currentQuestions.forEach((q,i)=>{
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if(selected && parseInt(selected.value,10) === q.correct) score++;
  });

  const pct = Math.round((score/currentQuestions.length)*100);
  alert(`Score: ${score}/${currentQuestions.length} (${pct}%)`);

  const user = auth.currentUser;
  const userName = user.displayName || user.email || "Student";

  db.collection("leaderboard").add({
    user: userName,
    email: user.email || "",
    score: score,
    total: currentQuestions.length,
    pct: pct,
    course: currentCourse,
    at: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{ loadLeaderboard(); });

  closeTest();
}

/* =========================
   LEADERBOARD
========================= */
function loadLeaderboard(){
  const div = document.getElementById("leaderboard");
  div.innerHTML = "Loading...";

  db.collection("leaderboard")
    .orderBy("pct","desc")
    .orderBy("score","desc")
    .limit(10)
    .get()
    .then(snapshot=>{
      if(snapshot.empty){
        div.innerHTML = `<div class="muted">No scores yet.</div>`;
        return;
      }
      let html = "";
      let i = 1;
      snapshot.forEach(doc=>{
        const d = doc.data();
        html += `
          <div style="margin:10px 0; padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.05)">
            <b>${i}. ${escapeHtml(d.user || "Student")}</b>
            <div class="small">${escapeHtml(d.course || "")} ‚Ä¢ ${d.score}/${d.total} ‚Ä¢ ${d.pct}%</div>
          </div>
        `;
        i++;
      });
      div.innerHTML = html;
    })
    .catch(e=> div.innerHTML = `<div class="muted">${escapeHtml(e.message)}</div>`);
}

/* =========================
   ADMIN: QUESTIONS (EDIT/DELETE/TRASH/SEARCH/BULK)
========================= */
let adminQuestions = []; // {id, data}
let adminSelected = new Set();

function getPickedCourse(){
  return (document.getElementById("coursePick").value || "").trim();
}

function clearQuestionForm(){
  document.getElementById("editQuestionId").value = "";
  document.getElementById("questionText").value="";
  document.getElementById("opt1").value="";
  document.getElementById("opt2").value="";
  document.getElementById("opt3").value="";
  document.getElementById("opt4").value="";
  document.getElementById("correct").value="";
  document.getElementById("imgUrl").value="";
  document.getElementById("audUrl").value="";
}

function fillEditForm(qid, q){
  document.getElementById("editQuestionId").value = qid;
  document.getElementById("questionText").value = q.question || "";
  document.getElementById("opt1").value = (q.options||[])[0] || "";
  document.getElementById("opt2").value = (q.options||[])[1] || "";
  document.getElementById("opt3").value = (q.options||[])[2] || "";
  document.getElementById("opt4").value = (q.options||[])[3] || "";
  document.getElementById("correct").value = (q.correct ?? "");
  document.getElementById("timeLimit").value = (q.time ?? "");
  document.getElementById("imgUrl").value = q.imageUrl || "";
  document.getElementById("audUrl").value = q.audioUrl || "";
  toast("Editing question");
}

function saveQuestion(){
  if(currentRole !== "admin") return alert("Admin only");
  const course = getPickedCourse();
  if(!course) return alert("Select course first");

  const qText = document.getElementById("questionText").value.trim();
  const o1 = document.getElementById("opt1").value.trim();
  const o2 = document.getElementById("opt2").value.trim();
  const o3 = document.getElementById("opt3").value.trim();
  const o4 = document.getElementById("opt4").value.trim();
  const correct = parseInt(document.getElementById("correct").value, 10);
  const time = parseInt(document.getElementById("timeLimit").value, 10);
  const imageUrl = document.getElementById("imgUrl").value.trim();
  const audioUrl = document.getElementById("audUrl").value.trim();
  const editId = document.getElementById("editQuestionId").value.trim();

  if(!qText || !o1 || !o2 || !o3 || !o4) return alert("Fill question + all options");
  if(Number.isNaN(correct) || correct<0 || correct>3) return alert("Correct must be 0-3");
  if(Number.isNaN(time) || time<=0) return alert("Time must be > 0 minutes");

  const payload = {
    question: qText,
    options: [o1,o2,o3,o4],
    correct,
    time,
    imageUrl: imageUrl || null,
    audioUrl: audioUrl || null,
    deleted: false,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: auth.currentUser.email || ""
  };

  const col = db.collection("courses").doc(course).collection("questions");

  if(editId){
    col.doc(editId).set(payload, { merge:true })
      .then(()=>{
        toast("Question updated!");
        clearQuestionForm();
        loadAdminQuestions();
      })
      .catch(e=>alert(e.message));
  } else {
    payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    payload.createdBy = auth.currentUser.email || "";
    col.add(payload)
      .then(()=>{
        toast("Question added!");
        clearQuestionForm();
        loadAdminQuestions();
      })
      .catch(e=>alert(e.message));
  }
}

function loadAdminQuestions(){
  if(currentRole !== "admin") return;
  const course = getPickedCourse();
  adminSelected.clear();
  adminQuestions = [];

  const info = document.getElementById("adminQInfo");
  const list = document.getElementById("adminQList");

  if(!course){
    info.textContent = "Select a course to load questions.";
    list.innerHTML = "";
    return;
  }

  info.textContent = "Loading...";
  list.innerHTML = "";

  const viewMode = document.getElementById("qViewMode").value;
  const col = db.collection("courses").doc(course).collection("questions");
  let qref = col;

  // active vs trash
  if(viewMode === "trash"){
    qref = qref.where("deleted","==",true);
  } else {
    qref = qref.where("deleted","==",false);
  }

  qref.get().then(snap=>{
    adminQuestions = [];
    snap.forEach(doc=>{
      adminQuestions.push({ id: doc.id, data: doc.data() });
    });
    info.textContent = `${adminQuestions.length} question(s) loaded.`;
    renderAdminQuestions();
  }).catch(e=>{
    info.textContent = "Error: " + e.message;
  });
}

function renderAdminQuestions(){
  const list = document.getElementById("adminQList");
  const search = (document.getElementById("qSearch").value || "").trim().toLowerCase();
  const viewMode = document.getElementById("qViewMode").value;

  let rows = adminQuestions;
  if(search){
    rows = rows.filter(x => (x.data.question || "").toLowerCase().includes(search));
  }

  if(rows.length === 0){
    list.innerHTML = `<div class="muted">No questions found.</div>`;
    return;
  }

  let html = "";
  rows.forEach((x, idx)=>{
    const q = x.data;
    const checked = adminSelected.has(x.id) ? "checked" : "";
    const badge = viewMode === "trash" ? `<span class="tag">üóëÔ∏è Deleted</span>` : "";

    html += `
      <div style="padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.05); margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="flex:1;">
            <label style="display:flex; gap:10px; align-items:flex-start; margin:0;">
              <input type="checkbox" style="width:18px;height:18px; accent-color: var(--brand);" ${checked}
                onchange="toggleSelectAdmin('${x.id}', this.checked)">
              <div>
                <b>${idx+1}. ${escapeHtml(q.question || "")}</b>
                <div class="small">Correct: ${["A","B","C","D"][q.correct] || "?"} ‚Ä¢ Time: ${q.time || "-"} min ${badge}</div>
                ${q.imageUrl ? `<div class="small">üñºÔ∏è Image: ${escapeHtml(q.imageUrl)}</div>` : ""}
                ${q.audioUrl ? `<div class="small">üîä Audio: ${escapeHtml(q.audioUrl)}</div>` : ""}
              </div>
            </label>
          </div>

          <div class="btnrow" style="justify-content:flex-end;">
            ${viewMode === "trash"
              ? `<button class="btn-ok" onclick="restoreQuestion('${x.id}')">Restore</button>`
              : `<button class="btn" onclick="editQuestion('${x.id}')">Edit</button>`
            }
            <button class="btn-bad" onclick="confirmDeleteQuestion('${x.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  });

  list.innerHTML = html;
}

function toggleSelectAdmin(id, on){
  if(on) adminSelected.add(id);
  else adminSelected.delete(id);
}

function selectAllAdmin(on){
  if(on){
    adminQuestions.forEach(x=> adminSelected.add(x.id));
  } else {
    adminSelected.clear();
  }
  renderAdminQuestions();
}

function editQuestion(id){
  const found = adminQuestions.find(x=>x.id===id);
  if(!found) return;
  fillEditForm(found.id, found.data);
}

function confirmDeleteQuestion(id){
  // Soft delete ON by default
  const msg = "Delete this question? (It will go to Trash and can be restored)";
  if(confirm(msg)){
    deleteQuestion(id, true);
  }
}

function deleteQuestion(id, soft=true){
  if(currentRole !== "admin") return alert("Admin only");
  const course = getPickedCourse();
  if(!course) return alert("Select course first");

  const ref = db.collection("courses").doc(course).collection("questions").doc(id);

  if(soft){
    ref.set({
      deleted: true,
      deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
      deletedBy: auth.currentUser.email || ""
    }, { merge:true }).then(()=>{
      toast("Moved to Trash");
      loadAdminQuestions();
    }).catch(e=>alert(e.message));
  } else {
    ref.delete().then(()=>{
      toast("Deleted permanently");
      loadAdminQuestions();
    }).catch(e=>alert(e.message));
  }
}

function restoreQuestion(id){
  if(currentRole !== "admin") return alert("Admin only");
  const course = getPickedCourse();
  if(!course) return alert("Select course first");

  db.collection("courses").doc(course).collection("questions").doc(id)
    .set({
      deleted: false,
      restoredAt: firebase.firestore.FieldValue.serverTimestamp(),
      restoredBy: auth.currentUser.email || ""
    }, { merge:true })
    .then(()=>{
      toast("Restored");
      loadAdminQuestions();
    })
    .catch(e=>alert(e.message));
}

function bulkDeleteSelected(){
  if(currentRole !== "admin") return alert("Admin only");
  const course = getPickedCourse();
  if(!course) return alert("Select course first");
  if(adminSelected.size === 0) return alert("Select questions first");

  if(!confirm(`Delete ${adminSelected.size} selected question(s)? (Soft delete to Trash)`)) return;

  const batch = db.batch();
  adminSelected.forEach(id=>{
    const ref = db.collection("courses").doc(course).collection("questions").doc(id);
    batch.set(ref, {
      deleted: true,
      deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
      deletedBy: auth.currentUser.email || ""
    }, { merge:true });
  });

  batch.commit().then(()=>{
    toast("Bulk delete done");
    adminSelected.clear();
    loadAdminQuestions();
  }).catch(e=>alert(e.message));
}

function bulkRestoreSelected(){
  if(currentRole !== "admin") return alert("Admin only");
  const course = getPickedCourse();
  if(!course) return alert("Select course first");
  if(adminSelected.size === 0) return alert("Select questions first");

  if(!confirm(`Restore ${adminSelected.size} selected question(s)?`)) return;

  const batch = db.batch();
  adminSelected.forEach(id=>{
    const ref = db.collection("courses").doc(course).collection("questions").doc(id);
    batch.set(ref, {
      deleted: false,
      restoredAt: firebase.firestore.FieldValue.serverTimestamp(),
      restoredBy: auth.currentUser.email || ""
    }, { merge:true });
  });

  batch.commit().then(()=>{
    toast("Bulk restore done");
    adminSelected.clear();
    loadAdminQuestions();
  }).catch(e=>alert(e.message));
}

/* =========================
   OPTIONAL: PWA SW REGISTER
   NOTE: service worker MUST be a separate file sw.js on GitHub.
========================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/* =========================
   FIRESTORE RULES (PASTE IN FIREBASE -> FIRESTORE -> RULES)
   (This is comment only; not executed)
========================= */
/*
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == "dnyanrui90@gmail.com" ||
        request.auth.token.email == "pawarjai999@gmail.com"
      );
    }

    match /courses/{courseId} {
      allow read: if signedIn();
      allow write: if isAdmin();
      match /questions/{qid} {
        allow read: if signedIn();
        allow write: if isAdmin();
      }
    }

    match /leaderboard/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update, delete: if false;
    }
  }
}
*/

/* =========================
   PWA FILES YOU ADD LATER (REQUIRED FOR INSTALL)
   1) manifest.json
   2) sw.js
   3) icon-192.png + icon-512.png
========================= */
/*
manifest.json
{
  "name": "TESTNEST",
  "short_name": "TESTNEST",
  "start_url": "./",
  "scope": "./",
  "display": "standalone",
  "background_color": "#0b1020",
  "theme_color": "#ff6b35",
  "icons": [
    { "src": "./icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "./icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}

sw.js
const CACHE = "testnest-pwa-v1";
self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open(CACHE).then((cache) =>
      cache.addAll(["./","./index.html","./manifest.json","./icon-192.png","./icon-512.png"])
    )
  );
});
self.addEventListener("activate", (event) => {
  event.waitUntil(
    caches.keys().then((keys) =>
      Promise.all(keys.filter((k) => k !== CACHE).map((k) => caches.delete(k)))
    )
  );
});
self.addEventListener("fetch", (event) => {
  event.respondWith(caches.match(event.request).then((c) => c || fetch(event.request)));
});
*/
</script>
</body>
</html>
